name: Android CI/CD Optimized

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # 前端构建部分保持不变...
  
  android-release:
    needs: [frontend-build, setup-gradle]
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle/android-release
      SIGNING_KEYSTORE_PASSWORD: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
      SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
      SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
      KEYSTORE_PATH: ${{ github.workspace }}/keystore.jks  # 添加绝对路径变量
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: frontend-assets
          path: android/app/src/main/assets
      
      - name: Setup Gradle Wrapper
        run: |
          cd android
          if [ ! -f "gradlew" ]; then
            gradle_version=${{ needs.setup-gradle.outputs.gradle-version }}
            curl -fsSL "https://services.gradle.org/distributions/gradle-$gradle_version-bin.zip" -o gradle.zip
            unzip -q gradle.zip
            rm gradle.zip
            "./gradle-$gradle_version/bin/gradle" wrapper --gradle-version "$gradle_version"
            rm -rf "gradle-$gradle_version"
          fi

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
      
      - name: Setup Signing Keystore
        run: |
          # 将密钥库直接放在工作区根目录
          echo "${{ secrets.SIGNING_KEYSTORE_BASE64 }}" | base64 -d > $KEYSTORE_PATH
          chmod 600 $KEYSTORE_PATH
          echo "Keystore created at: $KEYSTORE_PATH"
          ls -la $KEYSTORE_PATH
      
      - uses: actions/cache@v3
        with:
          path: ${{ env.GRADLE_USER_HOME }}
          key: gradle-${{ runner.os }}-android-release-${{ hashFiles('android/**/build.gradle') }}
          restore-keys: |
            gradle-${{ runner.os }}-android-release-
            gradle-${{ runner.os }}-
      
      - name: Build Release APK
        run: |
          cd android
          # 使用绝对路径
          ./gradlew clean assembleRelease \
            -Pandroid.injected.signing.store.file="$KEYSTORE_PATH" \
            -Pandroid.injected.signing.store.password="$SIGNING_KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$SIGNING_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$SIGNING_KEY_PASSWORD" \
            --no-daemon
            
      - uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/*.apk
          
      - name: Cleanup keystore
        run: rm -f $KEYSTORE_PATH
        if: always()
